<html>
  <head>
    <script src="../external/split.min.js"></script>
    <link href="../external/tabulator_midnight.min.css" rel="stylesheet" />
    <script type="text/javascript" src="../external/tabulator.min.js"></script>

    <style>
      .flex {
        display: flex;
        flex-direction: row;
      }

      .flex > .split {
        height: 100vh;
        overflow-y: scroll;
      }

      .gutter.gutter-horizontal {
        cursor: ew-resize;
      }

      .gutter {
        background-color: #eee;
        background-repeat: no-repeat;
        background-position: 50%;
      }

      .gutter.gutter-horizontal {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==");
      }

      .heading {
        padding: 15px;
        background: #eeeeee;
        text-align: center;
        font-weight: 800;
        color: #0062cc;
        letter-spacing: 2px;
      }

      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      li {
        margin-left: 7px;
      }

      .file {
        display: block;
        list-style: none;
      }

      .folder {
        list-style: none;
        cursor: pointer;

        > ul {
          display: none;
        }
      }

      .folder-open {
        > ul {
          display: block;
          padding-left: 15px;
          margin-left: 9px;
          border-left: 2px solid $color-grey;
        }
      }

      .hide {
        display: none;
        position: absolute;
        z-index: 10;
      }

      .show {
        display: block;
        position: absolute;
        z-index: 10;
      }

      .disabled {
        color: grey;
      }
    </style>
    <script>
      function createPOST() {
        var http = new XMLHttpRequest();
        var url =
          window.location.protocol +
          "/" +
          "/" +
          window.location.hostname +
          ":" +
          window.location.port +
          window.location.pathname;
        http.open("POST", url, true);
        http.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded",
        );
        return http;
      }

      function loadRightPart(url) {
        http = createPOST();
        http.onload = function () {
          if (http.status != 200) {
            alert(http.response);
          }

          var tmp = document.createElement("div");
          tmp.innerHTML = http.response;
          const scriptElements = tmp.querySelectorAll("script");
          Array.from(scriptElements).forEach((scriptElement) => {
            const clonedElement = document.createElement("script");
            Array.from(scriptElement.attributes).forEach((attribute) => {
              clonedElement.setAttribute(attribute.name, attribute.value);
            });
            clonedElement.text = scriptElement.text;
            scriptElement.parentNode.replaceChild(clonedElement, scriptElement);
          });
          document.getElementById("two").innerHTML = "";
          document.getElementById("two").appendChild(tmp);
        };

        http.onerror = function () {
          alert("login error");
        };

        const params = new URLSearchParams(window.location.search);
        http.send(url);
        return false;
      }

      function elementRename(elementPath) {
        let elpath = elementPath.split("/");

        while (true) {
          var x = prompt("Please enter unique name", elpath[elpath.length - 1]);

          if (x == null) {
            break;
          }

          if (
            document.getElementById(
              elementPath.replace(
                new RegExp(elpath[elpath.length - 1] + "$"),
                x,
              ),
            ) == null
          ) {
            http = createPOST();
            http.onload = function () {
              if (http.status != 200) {
                alert(http.response);
              } else {
                const params = new URLSearchParams(window.location.search);
                el = document.getElementById(elementPath);
                el.id = x;
                el.removeAttribute("onclick");
                el.addEventListener(
                  "click",
                  (e) => {
                    loadRightPart(
                      "file=" +
                        params.get("file") +
                        "&path=" +
                        elementPath.replace(
                          new RegExp(elpath[elpath.length - 1] + "$"),
                          x,
                        ),
                    );
                  },
                  false,
                );
                el.text = x;
              }
            };

            http.onerror = function () {
              alert("login error");
            };

            const params = new URLSearchParams(window.location.search);
            http.send(
              "file=" +
                params.get("file") +
                "&" +
                "op=renameelement&" +
                "path=" +
                elementPath +
                "&" +
                "new=" +
                x,
            );
            break;
          }
        }
        document.getElementById("stepmenu").classList.toggle("show");
      }

      function stepEnableDisable(stepName) {
        http = createPOST();
        http.onload = function () {
          if (http.status != 200) {
            alert(http.response);
          } else {
            document.getElementById(stepName).classList.toggle("disabled");
          }
        };

        http.onerror = function () {
          alert("login error");
        };

        const params = new URLSearchParams(window.location.search);
        http.send(
          "file=" +
            params.get("file") +
            "&op=enabledisablestep&old=" +
            stepName,
        );
        document.getElementById("stepmenu").classList.toggle("show");
      }

      function stepNew(stepName) {
        var x = prompt("Please enter new step name");
        if (x != stepName && x != null) {
          http = createPOST();
          http.onload = function () {
            if (http.status != 200) {
              alert(http.response);
            } else {
              liel = document.createElement("li");
              liel.class = "file";

              alel = document.createElement("a");
              alel.text = x;
              alel.id = x;
              alel.addEventListener(
                "click",
                (e) => {
                  loadRightPart("file=bela3.json&step=" + x);
                },
                false,
              );
              alel.class = "step";

              liel.appendChild(alel);

              el = document.getElementById(stepName);
              liparent = el.parentNode;
              liparent.parentNode.insertBefore(liel, liparent);

              updateStep(liel);
            }
          };

          http.onerror = function () {
            alert("login error");
          };

          const params = new URLSearchParams(window.location.search);
          http.send(
            "file=" +
              params.get("file") +
              "&op=newstep&old=" +
              stepName +
              "&new=" +
              x,
          );
          document.getElementById("stepmenu").classList.toggle("show");
        }
      }

      function stepClone(stepName) {
        var x = prompt("Please enter cloned step name");
        if (x != stepName && x != null) {
          http = createPOST();
          http.onload = function () {
            if (http.status != 200) {
              alert(http.response);
            } else {
              liel = document.createElement("li");
              liel.class = "file";

              alel = document.createElement("a");
              alel.text = x + "(copy)";
              alel.id = x + "(copy)";
              alel.addEventListener(
                "click",
                (e) => {
                  loadRightPart("file=bela3.json&step=" + x);
                },
                false,
              );
              alel.class = "step";

              liel.appendChild(alel);

              el = document.getElementById(stepName);
              liparent = el.parentNode;
              liparent.parentNode.insertBefore(liel, liparent);

              updateStep(liel);
            }
          };

          http.onerror = function () {
            alert("login error");
          };

          const params = new URLSearchParams(window.location.search);
          http.send(
            "file=" +
              params.get("file") +
              "&op=clonestep&old=" +
              stepName +
              "&new=" +
              x,
          );
          document.getElementById("stepmenu").classList.toggle("show");
        }
      }

      function stepDelete(stepName) {
        http = createPOST();
        http.onload = function () {
          if (http.status != 200) {
            alert(http.response);
          } else {
            el = document.getElementById(stepName);
            el.remove();
          }
        };

        http.onerror = function () {
          alert("login error");
        };

        const params = new URLSearchParams(window.location.search);
        http.send(
          "file=" + params.get("file") + "&op=deletestep&old=" + stepName,
        );
        document.getElementById("stepmenu").classList.toggle("show");
      }

      function tcNew(tcName) {
        var x = prompt("Please enter new test case name");
        if (x != tcName && x != null) {
          http = createPOST();
          http.onload = function () {
            if (http.status != 200) {
              alert(http.response);
            } else {
              liel = document.createElement("li");
              liel.class = "folder folder-open";

              ulel = document.createElement("ul");

              alel = document.createElement("a");
              alel.text = x;
              alel.id = x;
              alel.addEventListener(
                "click",
                (e) => {
                  loadRightPart("file=bela3.json&tc=" + x);
                },
                false,
              );
              alel.class = "tc";

              ulel.appendChild(alel);

              liel.appendChild(ulel);

              el = document.getElementById(tcName);
              liparent = el.parentNode;
              liparent.parentNode.insertBefore(liel, liparent);

              updateStep(liel);
            }
          };

          http.onerror = function () {
            alert("login error");
          };

          const params = new URLSearchParams(window.location.search);
          http.send(
            "file=" +
              params.get("file") +
              "&op=newtc&old=" +
              tcName +
              "&new=" +
              x,
          );
          document.getElementById("foldertc").classList.toggle("show");
        }
      }

      function savefile() {
        http = createPOST();
        http.onload = function () {
          if (http.status != 200) {
            alert(http.response);
          } else {
          }
        };

        http.onerror = function () {
          alert("login error");
        };

        const params = new URLSearchParams(window.location.search);
        http.send("file=" + params.get("file") + "&op=savefile");
      }

      function updatePopupMenu(toggler, name) {
        toggler.addEventListener("contextmenu", (e) => {
          popupMenuID = e.target.id;
          document.getElementById(name + "menu").classList.toggle("show");
          e.preventDefault();
        });
        toggler.addEventListener("mousemove", (e) => {
          if (document.getElementById(name + "menu").classList.contains("show"))
            return;
          if (!e) e = window.event;
          document.getElementById(name + "menu").style.top = e.pageY + "px";
          document.getElementById(name + "menu").style.left = e.pageX + "px";
        });
      }
    </script>
  </head>
  <body>
    <a href=".">back</a>
    <p>
      File:
      <!--NAME-->
      <button onclick="savefile();">Save</button>
    </p>

    <p>
      <!--<form>
Environment:
<select name="environment" id="environment">
ENV
</select>
</form>-->
    </p>

    <div class="flex">
      <div id="one" class="split">
        <!--TC-->
        <div id="menu"></div>
      </div>
      <div id="two" class="split">
        <!--OBIEKT-->
        <!--RUN-->
      </div>
    </div>

    var popupMenuID = "";

    <div
      class="hide"
      id="stepmenu"
      style="border: 5px outset black; background-color: white"
    >
      <a onclick="stepNew(popupMenuID)">New</a><br />
      <a onclick="elementRename(popupMenuID)">Rename</a><br />
      <a onclick="stepEnableDisable(popupMenuID)">Disable/enable</a><br />
      <a onclick="stepDelete(popupMenuID)">Delete</a><br />
      <a onclick="stepClone(popupMenuID)">Clone</a><br />
    </div>

    <div
      class="hide"
      id="foldermenu"
      style="border: 5px outset black; background-color: white"
    >
      TC
      <a onclick="tcNew(popupMenuID)">New</a><br />
      <a onclick="elementRename(popupMenuID)">Rename</a><br />
      <a onclick="tcEnableDisable(popupMenuID)">Disable/enable</a><br />
      <a onclick="tcDelete(popupMenuID)">Delete</a><br />
      <a onclick="tcClone(popupMenuID)">Clone</a><br />
    </div>

    <script>
      Split(["#one", "#two"], {
        sizes: [20, 80],
      });

      function addFilesFolders(treeObj, parentDomObj, id) {
        const params = new URLSearchParams(window.location.search);

        let liel1 = document.createElement("li");
        liel1.setAttribute("class", "folder folder-open");

        let alel1 = document.createElement("a");
        alel1.text = treeObj.name;
        console.log(id + treeObj.name);
        alel1.setAttribute("id", id + treeObj.name);
        alel1.setAttribute("class", "tcts");
        alel1.addEventListener(
          "click",
          (e) => {
            loadRightPart(
              "file=" + params.get("file") + "&path=" + id + treeObj.name,
            );
          },
          false,
        );

        let ulel1 = document.createElement("ul");

        liel1.appendChild(alel1);
        liel1.appendChild(ulel1);
        parentDomObj.appendChild(liel1);

        treeObj.folders.forEach(function (folder, index) {
          addFilesFolders(folder, ulel1, id + treeObj.name + "/");
        });
        treeObj.files.forEach(function (file, index) {
          let liel2 = document.createElement("li");
          liel2.setAttribute("class", "file");

          console.log(id + treeObj.name + "/" + file.name);
          let alel2 = document.createElement("a");
          alel2.text = file.name;
          alel2.setAttribute("id", id + treeObj.name + "/" + file.name);
          alel2.setAttribute(
            "class",
            "step" + (file.disabled ? " disabled" : ""),
          );
          alel2.addEventListener(
            "click",
            (e) => {
              loadRightPart(
                "file=" +
                  params.get("file") +
                  "&path=" +
                  id +
                  treeObj.name +
                  "/" +
                  file.name,
              );
            },
            false,
          );

          liel2.appendChild(alel2);
          ulel1.appendChild(liel2);
        });
      }

      ulel = document.createElement("ul");
      document.getElementById("menu").appendChild(ulel);
      tree.forEach(function (folder, index) {
        addFilesFolders(folder, ulel, "");
      });

      var toggler = document.getElementsByClassName("folder");
      for (var i = 0; i < toggler.length; i++) {
        const node = document.createElement("a");
        node.innerHTML = toggler[i].classList.contains("folder-open")
          ? "\u25BC "
          : "\u25B6 ";
        node.addEventListener("click", function () {
          this.innerHTML = this.innerHTML == "\u25B6 " ? "\u25BC " : "\u25B6 ";
          this.parentElement.classList.toggle("folder-open");
        });
        toggler[i].prepend(node);
      }

      var toggler = document.getElementsByClassName("tcts");
      for (var i = 0; i < toggler.length; i++) {
        updatePopupMenu(toggler[i], "folder");
      }
      var toggler = document.getElementsByClassName("file");
      for (var i = 0; i < toggler.length; i++) {
        updatePopupMenu(toggler[i], "step");
      }
    </script>
  </body>
</html>
