<!doctype html>
<html>
<head>
    <script src="../external/split.min.js"></script>
    <link href="../external/tabulator_midnight.min.css" rel="stylesheet">
    <script type="text/javascript" src="../external/tabulator.min.js"></script>

    <style>
        .flex {
            display: flex;
            flex-direction: row;
        }

        .flex>.split {
            height: 100vh;
            overflow-y: scroll;
        }

        .gutter.gutter-horizontal {
            cursor: ew-resize;
        }

        .gutter {
            background-color: #eee;
            background-repeat: no-repeat;
            background-position: 50%;
        }

        .gutter.gutter-horizontal {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
        }

        .heading {
            padding: 15px;
            background: #eeeeee;
            text-align: center;
            font-weight: 800;
            color: #0062cc;
            letter-spacing: 2px;
        }

	ul {
    	    list-style-type: none;
    	     margin:0;
    	    padding:0;
	}

	li {
    	    margin-left:7px;
	}

	.file {
    	    display: block;
    	    list-style: none;
	}

	.folder {
    	    list-style: none;
            cursor: pointer;

	    > ul {
        	display: none;
    	    }
	}
    
	.folder-open {
    	    > ul {
        	display: block;
        	padding-left: 15px;
        	margin-left: 9px;
        	border-left: 2px solid $color-grey;
    	    }
	}

	.hide {
    	  display: none;
            position: absolute;
            z-index: 10;
	}

	.show {
    	  display: block;
            position: absolute;
            z-index: 10;
	}

	.disabled {
	    color:grey;
	}
</style>
<script>

function createPOST() {
  var http = new XMLHttpRequest();
  var url = window.location.protocol + '/' + '/' + window.location.hostname + ':' + window.location.port + window.location.pathname;
  http.open('POST', url, true);
  http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  return http;
}

function loadRightPart(url) {
  http = createPOST();
  http.onload = function() {
    if (http.status != 200) {
      alert(http.response);
    }

    var tmp=  document.createElement('div');
    tmp.innerHTML = http.response;
    const scriptElements = tmp.querySelectorAll("script");
    Array.from(scriptElements).forEach((scriptElement) => {
      const clonedElement = document.createElement("script");
      Array.from(scriptElement.attributes).forEach((attribute) => {
        clonedElement.setAttribute(attribute.name, attribute.value);
      });
      clonedElement.text = scriptElement.text;
      scriptElement.parentNode.replaceChild(clonedElement, scriptElement);
    });
    document.getElementById("two").innerHTML="";
    document.getElementById("two").appendChild(tmp);
  }

  http.onerror = function() {
    alert('login error');
  };

  const params = new URLSearchParams(window.location.search);
  http.send(url);
  return false;
}

function stepRename(stepName) {
    var x = prompt("Please enter step name",stepName);
    if (x!= stepName && x!=null) {
        http = createPOST();
        http.onload = function() {
          if (http.status != 200) {
            alert(http.response);
          } else {
    	    el = document.getElementById(stepName);
	    el.id = x;
el.removeAttribute('onclick');
el.addEventListener(
  "click",
  (e) => {
loadRightPart("file=bela3.json&step="+x);
  },
  false,
);
el.text = x;
          }
        }

        http.onerror = function() {
          alert('login error');
         };

        const params = new URLSearchParams(window.location.search);
        http.send("file="+params.get('file')+"&op=renamestep&old="+stepName+"&new="+x);
	document.getElementById("cnt").classList.toggle("show");
    }
}

function stepEnableDisable(stepName) {
        http = createPOST();
        http.onload = function() {
          if (http.status != 200) {
            alert(http.response);
          } else {
	document.getElementById(stepName).classList.toggle("disabled");
          }
        }

        http.onerror = function() {
          alert('login error');
         };

        const params = new URLSearchParams(window.location.search);
        http.send("file="+params.get('file')+"&op=enabledisablestep&old="+stepName);
	document.getElementById("cnt").classList.toggle("show");
}

function stepDelete(stepName) {
        http = createPOST();
        http.onload = function() {
          if (http.status != 200) {
            alert(http.response);
          } else {
    	    el = document.getElementById(stepName);
	    el.remove();
          }
        }

        http.onerror = function() {
          alert('login error');
         };

        const params = new URLSearchParams(window.location.search);
        http.send("file="+params.get('file')+"&op=deletestep&old="+stepName);
	document.getElementById("cnt").classList.toggle("show");
}

function savefile() {
        http = createPOST();
        http.onload = function() {
          if (http.status != 200) {
            alert(http.response);
          } else {
          }
        }

        http.onerror = function() {
          alert('login error');
         };

        const params = new URLSearchParams(window.location.search);
        http.send("file="+params.get('file')+"&op=savefile");
}

</script>
</head>
<body>
<a href=.>back</a><p>
File: <!--NAME-->
<button onclick=savefile();>Save</button>
<p>
<!--<form>
Environment:
<select name="environment" id="environment">
ENV
</select>
</form>-->
<div class="flex">
  <div id="one" class="split">
     <!--TC-->
  </div>
  <div id="two" class="split">
    <!--OBIEKT-->
    <!--RUN-->
  </div>
</div>

var popupMenuID = "";

<div class="hide" id="cnt" style="border:5px outset black; background-color: white;">
   New<br>
   <a onclick=stepRename(popupMenuID)>Rename</a><br>
   <a onclick=stepEnableDisable(popupMenuID)>Disable/enable</a><br>
   Clone<br>
   <a onclick=stepDelete(popupMenuID)>Delete</a><br>
</div>

<script>

Split(['#one', '#two'], {
    sizes: [20, 80]
});

var toggler = document.getElementsByClassName("folder");
for (var i = 0; i < toggler.length; i++) {
  const node = document.createElement("a");
  node.innerHTML = toggler[i].classList.contains("folder-open")?"\u25BC ":"\u25B6 ";
  node.addEventListener("click", function() {
      this.innerHTML = this.innerHTML=="\u25B6 "?"\u25BC ":"\u25B6 ";
      this.parentElement.classList.toggle("folder-open");
  });
  toggler[i].prepend(node);
} 

var toggler = document.getElementsByClassName("step");
for (var i = 0; i < toggler.length; i++) {
    toggler[i].addEventListener("contextmenu", (e) => {
      popupMenuID = e.target.id;
      document.getElementById("cnt").classList.toggle("show");
      e.preventDefault();
    });
    toggler[i].addEventListener('mousemove', (e) => {
      if (document.getElementById("cnt").classList.contains("show")) return;
      if (!e) e = window.event;
      document.getElementById("cnt").style.top = e.pageY + 'px';
      document.getElementById("cnt").style.left = e.pageX + 'px';
    });
} 

var toggler = document.getElementsByClassName("cnt");
for (var i = 0; i < toggler.length; i++) {
    toggler[i].addEventListener("contextmenu", (e) => {
	document.getElementById("cnt").classList.toggle("show");
        e.preventDefault();
    });
}

</script>
</body>
</html>
