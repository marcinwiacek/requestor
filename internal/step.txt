<br>
<script async=async>
function selectMethod(name,name2) {
    var selObj = document.getElementById(name);
    for (var i = 0; i < selObj.options.length; i++) {
        if (selObj.options[i].text.toUpperCase()==name2.toUpperCase()) {
            selObj.options[i].selected = true;
            break;
        }
    }
}

function setupLast(obj) {
      console.log(http.response);

    document.getElementById("lastrequesttype").value =obj.method.toUpperCase();
    document.getElementById("lastrequesturl").value =obj.url;
    document.getElementById("lastrequestheaders").value ="";
    for (var i =0;i<obj.headers.length;i++) {
      document.getElementById("lastrequestheaders").value =
      document.getElementById("lastrequestheaders").value+decodeURIComponent(obj.headers[i])+"\n";
    }
    document.getElementById("lastrequestbody").value  = decodeURIComponent(obj.body);
    document.getElementById("lastresponseheaders").value ="";
    for (var i =0;i<obj.headers_res.length;i++) {
      document.getElementById("lastresponseheaders").value =
      document.getElementById("lastresponseheaders").value+decodeURIComponent(obj.headers_res[i])+"\n";
    }
    document.getElementById("lastresponsetime").value  = decodeURIComponent(obj.datetime_res);
    document.getElementById("lastresponsebody").value  = decodeURIComponent(obj.body_res);
    document.getElementById("lastresponsecode").value  = obj.code_res;
    document.getElementById("lastresponsecert").value  = decodeURIComponent(obj.cert_res);
    document.getElementById("lastresponseerror").value  = decodeURIComponent(obj.errors);
    document.getElementById("lastignorewrongssl").checked  = obj.ssl_ignore=="1";
}

function selectLastDate() {
  if (document.getElementById("whenlast").value=="") return;

  http = createPOST();
  http.onload = function() {
    if (http.status != 200) {
      alert(http.response);
    } else {
      setupLast(JSON.parse(http.response));
    }
  }

  http.onerror = function() {
    alert('login error');
  };

  const params = new URLSearchParams(window.location.search);
  http.send("file="+params.get('file')+"&getstep="+document.getElementById("name").value+"&dt="+encodeURIComponent(document.getElementById("whenlast").value));
  return false;
}

function sendNewStep() {
  http = createPOST();
  http.onload = function() {
    if (http.status != 200) {
      alert(http.response);
    } else {
      var obj = JSON.parse(http.response);

      for (var i=0;i<obj.oldtimes.length;i++) {
        var option1 = document.createElement("option");
        option1.value = obj.oldtimes[i];
        option1.text = obj.oldtimes[i];
        var selObj1 = document.getElementById("whenlast");
        selObj1.prepend(option1);
      }

      var option = document.createElement("option");
      option.value = obj.datetime;
      option.text = obj.datetime;
      var selObj = document.getElementById("whenlast");
      selObj.prepend(option);

      for (var i = 0; i < selObj.options.length; i++) {
          if (selObj.options[i].text==obj.datetime) {
            selObj.options[i].selected = true;
            break;
          }
      }

      setupLast(obj);
    }
  }

  http.onerror = function() {
    alert('login error');
  };

  var method ="";
  var selObj = document.getElementById("type");
  for (var i = 0; i < selObj.options.length; i++) {
        if (selObj.options[i].selected) { 
            method = selObj.options[i].value;
            break;
        }
  }

  const params = new URLSearchParams(window.location.search);
  http.send("file="+params.get('file')+"&runstep="+document.getElementById("name").value+"&headers="+encodeURIComponent(document.getElementById("header").value)+
    "&body="+encodeURIComponent(document.getElementById("body").value)+
    "&url="+encodeURIComponent(document.getElementById("url").value)+
    "&ssl="+document.getElementById("ignorewrongssl").checked+
    "&method="+method);

  return false;
};
</script>
<form onsubmit="return sendNewStep()">
<table><tr><td valign=bottom>
  <p><input type="checkbox" id="disabled" />Disabled
  <br>Name <input type="text" id="name" value="<!--NAME-->" size=61>
</td>
<td valign=bottom>
  <p>When 
  <select id="whenlast" onchange="selectLastDate()">
      <!--WHENLAST-->
  </select>
</td>
<td valign=bottom>
</td>
</tr>
<tr><td valign=top>
  <select id="type">
    <option value="get">GET</option>
    <option value="head">HEAD</option>
    <option value="post">POST</option>
    <option value="put">PUT</option>
    <option value="delete">DELETE</option>
    <option value="connect">CONNECT</option>
    <option value="options">OPTIONS</option>
    <option value="trace">TRACE</option>
    <option value="patch">PATCH</option>
  </select> 
<script>selectMethod("type","<!--METHOD-->");</script>
<!--URLPREFIX-->&nbsp;&nbsp;
  <input type="text" id="url" value="<!--URL-->" size=57>
  <p>Headers<br><textarea cols=80 rows=5 id="header"><!--HEADER--></textarea>
  <p>Body<br><textarea cols=80 rows=5  id="body"><!--BODY--></textarea>
  <p><input type="checkbox" id="ignorewrongssl" <!--SSLIGNORE--> />Ignore SSL errors
  <p>Asserts
  <p><select id="x">
    <option value="GET">HTTP code</option>
    <option value="POST">Headers</option>
    <option value="POST">Body</option>
  </select>
  <input type="text" id="url2" value="200" size=40>
  <p><button type="submit">Run</button>
</td>
<td valign=top>
  <input type=text id="lastrequesttype" size=6>
  <!--URLPREFIX-->
  &nbsp;&nbsp;<input type="text" id="lastrequesturl" value="" size=61>
  <p>Headers<br><textarea cols=80 rows=5 id=lastrequestheaders></textarea>
  <p>Body<br><textarea cols=80 rows=5 id=lastrequestbody></textarea>
  <p><input type="checkbox" id="lastignorewrongssl" />Ignore SSL errors
  <p>HTTP response <input type=text id=lastresponsetime>
  <p>Code <input type=text id=lastresponsecode>
  <p>Headers<br><textarea cols=80 rows=5 id=lastresponseheaders></textarea>
  <p>Body<br><textarea cols=80 rows=5 id=lastresponsebody></textarea>
  <p>Certificates<br><textarea cols=80 rows=5 id=lastresponsecert></textarea>
  <p>Errors<br><textarea cols=80 rows=5 id=lastresponseerror></textarea>
</td>
<td valign=top>
</td>
</tr></table>
</form>
<script>
selectLastDate();
</script>
